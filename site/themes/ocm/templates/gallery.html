{% extends "base.html" %}

{% block content %}
<div class="gallery-container">
    <h1>{{ section.title }}</h1>
    {{ section.content | safe }}
    
    <div class="test-categories">
        <div class="category" id="auth-tests">
            <h2>Authentication Tests üîê</h2>
            <div class="test-grid">
                <!-- Authentication test videos will be loaded here -->
            </div>
        </div>

        <div class="category" id="share-link-tests">
            <h2>Public Link Sharing Tests üîó</h2>
            <div class="test-grid">
                <!-- Share link test videos will be loaded here -->
            </div>
        </div>

        <div class="category" id="share-with-tests">
            <h2>Direct User Sharing Tests ü§ù</h2>
            <div class="test-grid">
                <!-- Share with test videos will be loaded here -->
            </div>
        </div>

        <div class="category" id="sciencemesh-tests">
            <h2>ScienceMesh Federation Tests üåê</h2>
            <div class="test-grid">
                <!-- ScienceMesh test videos will be loaded here -->
            </div>
        </div>
    </div>

    <template id="test-card-template">
        <div class="test-card">
            <div class="video-container">
                <video controls preload="none">
                    <source src="" type="video/webm">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="test-info">
                <h3 class="test-name"></h3>
                <div class="test-status"></div>
                <p class="test-description"></p>
            </div>
        </div>
    </template>

    <script>
        // Function to format workflow name into a readable title
        function formatWorkflowName(name) {
            return name
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Function to determine the category from workflow name
        function getCategory(workflowName) {
            if (workflowName.startsWith('login')) return 'auth-tests';
            if (workflowName.startsWith('share-link')) return 'share-link-tests';
            if (workflowName.startsWith('share-with')) return 'share-with-tests';
            if (workflowName.startsWith('invite-link')) return 'sciencemesh-tests';
            return null;
        }

        // Function to create a test card
        function createTestCard(videoData) {
            console.log('Creating card for video:', videoData);
            const template = document.getElementById('test-card-template');
            const card = template.content.cloneNode(true);
            
            const video = card.querySelector('video');
            const source = video.querySelector('source');
            
            // Strip 'site/static/' from paths since Zola copies everything from site/static to root
            const videoPath = videoData.video.replace(/^site\/static\//, '');
            const thumbnailPath = videoData.thumbnail.replace(/^site\/static\//, '');
            
            const baseUrl = '{{ get_url(path="/") | safe }}'.replace(/\/+$/, '');
            source.src = `${baseUrl}/${videoPath}`;
            video.poster = `${baseUrl}/${thumbnailPath}`;
            
            console.log('Video source:', source.src);
            console.log('Video poster:', video.poster);
            
            const title = card.querySelector('.test-name');
            title.textContent = formatWorkflowName(videoData.workflow);
            
            const status = card.querySelector('.test-status');
            status.innerHTML = `<img src="https://img.shields.io/github/actions/workflow/status/pondersource/dev-stock/${videoData.workflow}.yml?branch=main&style=flat-square" alt="Test Status">`;
            
            return card;
        }

        // Load videos and organize them into categories
        async function loadVideos() {
            try {
                console.log('Starting to load videos...');
                const baseUrl = '{{ get_url(path="/") | safe }}'.replace(/\/+$/, ''); // Remove trailing slashes
                const manifestUrl = `${baseUrl}/artifacts/manifest.json`;
                console.log('Fetching manifest from:', manifestUrl);
                
                const response = await fetch(manifestUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Loaded manifest data:', data);
                
                if (!data.videos || !Array.isArray(data.videos)) {
                    console.error('Invalid manifest format - missing videos array');
                    return;
                }
                
                data.videos.forEach(videoData => {
                    console.log('Processing video:', videoData);
                    const category = getCategory(videoData.workflow);
                    console.log('Category:', category);
                    if (category) {
                        const container = document.querySelector(`#${category} .test-grid`);
                        if (container) {
                            const card = createTestCard(videoData);
                            container.appendChild(card);
                        } else {
                            console.error('Container not found for category:', category);
                        }
                    } else {
                        console.warn('No category found for workflow:', videoData.workflow);
                    }
                });
            } catch (error) {
                console.error('Error loading videos:', error);
                // Add visible error message to the page
                const errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.style.padding = '1em';
                errorDiv.textContent = `Error loading videos: ${error.message}`;
                document.querySelector('.gallery-container').appendChild(errorDiv);
            }
        }

        // Initialize the gallery
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing gallery...');
            loadVideos();
        });
    </script>
</div>
{% endblock content %} 