{% extends "base.html" %}

{% block content %}
<div class="matrix-container">
    {% if section.title %}
        <h1>{{ section.title }}</h1>
    {% endif %}
    {{ section.content | safe }}

    <script>
        // Function to get GitHub token from URL parameter or localStorage
        function getGitHubToken() {
            const params = new URLSearchParams(window.location.search);
            let token = params.get('token');
            if (token) {
                localStorage.setItem('github_token', token);
                // Remove token from URL
                const newUrl = window.location.pathname + window.location.hash;
                window.history.replaceState({}, document.title, newUrl);
            } else {
                token = localStorage.getItem('github_token');
            }
            return token;
        }

        // Function to fetch and display artifact information
        async function fetchArtifacts(workflowId) {
            const token = getGitHubToken();
            const headers = token ? { 'Authorization': `token ${token}` } : {};
            
            try {
                const response = await fetch(`https://api.github.com/repos/pondersource/dev-stock/actions/workflows/${workflowId}/runs`, { headers });
                const data = await response.json();
                if (data.workflow_runs && data.workflow_runs.length > 0) {
                    const latestRun = data.workflow_runs[0];
                    const artifactsUrl = latestRun.artifacts_url;
                    const artifactsResponse = await fetch(artifactsUrl, { headers });
                    const artifactsData = await artifactsResponse.json();
                    return { artifacts: artifactsData.artifacts, runId: latestRun.id };
                }
            } catch (error) {
                console.error('Error fetching artifacts:', error);
            }
            return null;
        }

        // Function to create the auth notice
        function createAuthNotice() {
            const notice = document.createElement('div');
            notice.className = 'auth-notice';
            notice.innerHTML = `
                <p>To download artifacts, you need to authenticate with GitHub.</p>
                <p>Create a <a href="https://github.com/settings/tokens/new?scopes=actions:read" target="_blank">GitHub token</a> with 'actions:read' permission and add it to the URL as: <code>?token=YOUR_TOKEN</code></p>
            `;
            return notice;
        }

        // Function to update badge links with artifact information
        async function updateBadgeLinks() {
            const badges = document.querySelectorAll('img[src*="actions/workflow"]');
            const token = getGitHubToken();

            badges.forEach(async (badge) => {
                const workflowPath = badge.src.match(/workflow\/(.+?)\.yml/)?.[1];
                if (workflowPath) {
                    const result = await fetchArtifacts(`${workflowPath}.yml`);
                    if (result && result.artifacts && result.artifacts.length > 0) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'badge-wrapper';
                        badge.parentNode.insertBefore(wrapper, badge);
                        wrapper.appendChild(badge);
                        
                        const artifactsList = document.createElement('div');
                        artifactsList.className = 'artifacts-list';

                        if (!token) {
                            artifactsList.appendChild(createAuthNotice());
                        } else {
                            result.artifacts.forEach(artifact => {
                                const link = document.createElement('a');
                                link.href = `https://nightly.link/pondersource/dev-stock/actions/artifacts/${artifact.id}.zip`;
                                link.textContent = `ðŸ“¥ ${artifact.name}`;
                                link.target = '_blank';
                                artifactsList.appendChild(link);
                            });
                        }
                        wrapper.appendChild(artifactsList);
                    }
                }
            });
        }

        // Call the update function when the page loads
        document.addEventListener('DOMContentLoaded', updateBadgeLinks);
    </script>
</div>
{% endblock content %} 