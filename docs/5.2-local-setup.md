# Local Setup
This guide provides instructions for setting up a local development environment for the OCM test suite in the dev-stock repository. This environment consists of Docker containers for various Enterprise File Synchronization and Sharing (EFSS) platforms (Nextcloud, ownCloud, OCIS, Seafile, OCM Stub) and testing tools for evaluating federated sharing functionality.


## Prerequisites
- Docker Engine
- Git
- Bash shell
- Sufficient disk space for Docker images (several GB)
- Port availability (4501-4506, 5700, 5800, 9003)

## Architecture Overview
The local development environment consists of multiple Docker containers networked together:

Docker Environment

Testing Tools

OCM Components

Database Backends

EFSS Platforms

Tests

Tests

Tests

Tests

Tests

Cypress
(cypress.docker)

Nextcloud (nextcloud*.docker)

MariaDB for Nextcloud
(marianextcloud*.docker)

ownCloud (owncloud*.docker)

MariaDB for ownCloud
(mariaowncloud*.docker)

Seafile (seafile*.docker)

MariaDB for Seafile
(mariaseafile*.docker)

Memcached for Seafile
(memcacheseafile*.docker)

Reva for Nextcloud
(revanextcloud*.docker)

Reva for ownCloud
(revaowncloud*.docker)

Mesh Directory
(meshdir.docker)

OCIS (ocis*.docker)

OCM Stub (ocmstub*.docker)

Firefox
(firefox.docker)

VNC Server
(vnc.docker)

testnet Docker Network

Sources: 
scripts/utils/container/nextcloud.sh
 
scripts/utils/container/owncloud.sh
 
scripts/utils/container/ocis.sh
 
scripts/utils/container/seafile.sh
 
scripts/utils/container/ocmstub.sh
 
scripts/utils/container/reva.sh
 
scripts/utils/container/mehsdir.sh
 
scripts/utils/container/firefox.sh
 
scripts/utils/container/vnc.sh

Container Management Scripts
The repository includes several scripts for managing the development environment:

Utility Scripts

Container Creation Scripts

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

Uses

scripts/clean.sh

nextcloud.sh

owncloud.sh

ocis.sh

seafile.sh

ocmstub.sh

reva.sh

mehsdir.sh

firefox.sh

vnc.sh

docker.sh

ci.sh

Sources: 
scripts/clean.sh
 
scripts/utils/docker.sh
 
scripts/utils/test_modes/ci.sh

Setup Options
Option 1: Gitpod (Cloud Development Environment)
The repository is configured for Gitpod, which provides a pre-configured development environment:

Open the repository in Gitpod: 
Open in Gitpod

Gitpod will execute the prebuild script to initialize the environment.

Sources: 
.gitpod.yml
 
.gitpod.Dockerfile
 
init/prebuild.sh

Option 2: Local Setup
For local setup, follow these steps:

Clone the repository:

git clone https://github.com/pondersource/dev-stock.git
cd dev-stock
Run the prebuild script to pull all required Docker images:

./init/prebuild.sh
Clean and initialize the Docker environment:

./scripts/clean.sh
The clean.sh script performs several important functions:

Stops and removes Docker containers
Prunes Docker volumes and system resources
Recreates the "testnet" Docker network
Sources: 
init/prebuild.sh
 
scripts/clean.sh
15-252

Managing Containers
Creating EFSS Platform Containers
The repository includes scripts for creating different EFSS platform containers:

Nextcloud
# Function signature: create_nextcloud(number, user, password, image, tag, [extra_env], [is_ci_image])
# Example:
create_nextcloud 1 "admin" "password" "pondersource/nextcloud" "v27.0.0"
Source: 
scripts/utils/container/nextcloud.sh
99-101

ownCloud
# Function signature: create_owncloud(number, user, password, image, tag)
# Example:
create_owncloud 1 "admin" "password" "pondersource/owncloud" "v10.13.0"
Source: 
scripts/utils/container/owncloud.sh
4-45

Seafile
# Function signature: create_seafile(number, user, password, image, tag, remote_ocm_server)
# Example:
create_seafile 1 "admin@example.com" "password" "pondersource/seafile" "v10.0.1" "nextcloud1.docker"
Source: 
scripts/utils/container/seafile.sh
4-72

OCIS
# Function signature: create_ocis(number, image, tag)
# Example:
create_ocis 1 "pondersource/ocis" "v5.0.0"
Source: 
scripts/utils/container/ocis.sh
4-46

OCM Stub
# Function signature: create_ocmstub(number, image, tag)
# Example:
create_ocmstub 1 "pondersource/ocmstub" "v1.0.0"
Source: 
scripts/utils/container/ocmstub.sh
4-21

Automated Test Environment Setup
Instead of creating containers manually, you can use the test scripts to set up a complete test environment. For example:

# Sets up Nextcloud and ownCloud containers with their databases and testing tools
./scripts/nextcloud-owncloud.sh v27.0.0 v10.13.0 dev electron
This creates:

Nextcloud container with MariaDB
ownCloud container with MariaDB
Reva containers for OCM
Mesh Directory
Cypress, Firefox, and VNC for testing
Cleaning Up
To clean up the Docker environment, use the clean.sh script:

./scripts/clean.sh
This script:

Stops and removes Docker containers
Prunes Docker volumes and system resources
Recreates the "testnet" Docker network
Source: 
scripts/clean.sh
104-137

Selective Cleanup
You can also clean up specific containers by providing their names as arguments:

./scripts/clean.sh no cypress meshdir firefox vnc nextcloud1 owncloud1
The first argument (no) prevents the terminal from being cleared after cleanup.

Source: 
scripts/clean.sh
169-245

Port Configuration
The development environment uses several ports:

Port	Service	Description
4501-4506	EFSS Platforms	Various EFSS platform services
5700	VNC	VNC server to view Cypress
5800	Firefox	Embedded browser to access docker containers
9003	Xdebug	Xdebug client port
Source: 
.gitpod.yml
30-64

Debugging and Development
Xdebug Support
Xdebug is configured for PHP debugging in the Nextcloud and ownCloud containers:

zend_extension=xdebug.so
xdebug.mode="develop,debug,coverage"
xdebug.start_with_request = yes
xdebug.client_host = "host.docker.internal"
xdebug.client_port = "9003"
xdebug.idekey="VSCODE"
xdebug.log=/var/www/html/xdebug.log
xdebug.log_level = 0
Source: 
docker/configs/20-xdebug.ini

Visual Testing with VNC
For visual testing, the environment includes a VNC server:

VNC server available at: http://localhost:5700
Firefox browser available at: http://localhost:5800
This allows you to watch tests run in real-time.

Common Issues and Troubleshooting
Container Creation Failures
If container creation fails, check:

Docker daemon is running
Sufficient system resources (memory, disk space)
Port conflicts (check with docker ps or netstat -tuln)
Network Issues
If containers can't communicate, ensure the "testnet" Docker network exists:

docker network inspect testnet
If it doesn't exist, it can be created with:

docker network create testnet
Or use the clean script's function:

./scripts/clean.sh
Source: 
scripts/clean.sh
139-163

Resource Limitations
The development environment can be resource-intensive. If you experience performance issues:

Stop unused containers to free resources
Increase Docker's resource allocation in Docker Desktop settings
Use selective container creation instead of starting all containers
Docker Permission Issues
If you encounter permission issues with Docker:

# Add current user to docker group (Linux)
sudo usermod -aG docker $USER
# Then log out and log back in
Handling Failed Test Runs
If tests fail or containers become corrupted:

# Clean everything and start fresh
./scripts/clean.sh
This will remove all containers, prune volumes, and recreate the network.